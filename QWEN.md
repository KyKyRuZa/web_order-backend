# WebDev Orders API - Проект документации

## Обзор проекта

Это приложение Node.js/Express сервера, которое служит API для системы управления заказами на веб-разработку. Приложение позволяет клиентам отправлять заказы на услуги веб-разработки и позволяет менеджерам и администраторам просматривать, обрабатывать и отслеживать эти заказы.

### Ключевые технологии
- **Backend**: Node.js с Express.js
- **База данных**: PostgreSQL с ORM Sequelize
- **Аутентификация**: JWT токены
- **Логирование**: Winston
- **Валидация**: Express-validator
- **Безопасность**: Helmet, CORS, Ограничение частоты запросов
- **Загрузка файлов**: Multer

### Архитектура
- **Model-View-Controller (MVC)** паттерн с контроллерами, сервисами и моделями
- **RESTful API** дизайн
- **Конфигурация на основе окружения** (development, test, production)
- **Комплексное логирование** с файловым и консольным выводом

## Сборка и запуск

### Предварительные требования
- Node.js (v14 или выше рекомендуется)
- База данных PostgreSQL
- Настроенные переменные окружения

### Инструкции по установке

1. **Установка зависимостей**:
```bash
npm install
```

2. **Настройка переменных окружения**, создав файл `.env` на основе шаблона:
```env
NODE_ENV=development
PORT=5000
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=password
DB_NAME=webdev_orders_dev
CLIENT_URL=http://localhost:3000
JWT_SECRET=your_jwt_secret_here
JWT_REFRESH_SECRET=your_refresh_secret_here
```

3. **Запуск миграций базы данных** (если есть):
```bash
npm run db:migrate
```

4. **Запуск сервера разработки**:
```bash
npm run dev
```

5. **Запуск сервера продакшена**:
```bash
npm start
```

### Доступные скрипты

| Скрипт | Описание |
|--------|----------|
| `npm run dev` | Запуск сервера разработки с nodemon |
| `npm run start` | Запуск сервера продакшена |
| `npm run seed` | Заполнение базы данных тестовыми данными |
| `npm run logs` | Просмотр общих логов |
| `npm run logs:error` | Просмотр логов ошибок |
| `npm run db:create` | Создание базы данных |
| `npm run db:drop` | Удаление базы данных |
| `npm run db:migrate` | Запуск миграций базы данных |
| `npm run db:migrate:undo` | Откат последней миграции |
| `npm run db:seed` | Заполнение базы данных тестовыми данными |
| `npm run db:seed:undo` | Удаление тестовых данных |

## API Эндпоинты

### Аутентификация (`/api/auth`)
- `POST /register` - Регистрация нового пользователя
- `POST /login` - Вход пользователя
- `POST /refresh-token` - Обновление токена доступа
- `GET /verify-email/:token` - Подтверждение email адреса
- `POST /forgot-password` - Запрос сброса пароля
- `POST /reset-password/:token` - Сброс пароля
- `POST /logout` - Выход пользователя
- `GET /profile` - Получение профиля пользователя
- `PUT /profile` - Обновление профиля
- `PUT /change-password` - Изменение пароля
- `GET /applications` - Получение заявок пользователя
- `GET /stats` - Получение статистики пользователя
- `DELETE /deactivate` - Деактивация аккаунта

### Заявки (`/api/applications`)
- `GET /` - Получение всех заявок (для аутентифицированного пользователя)
- `POST /` - Создание новой заявки
- `GET /:id` - Получение конкретной заявки
- `PUT /:id` - Обновление заявки
- `DELETE /:id` - Удаление заявки
- `POST /:id/submit` - Отправка заявки
- `GET /:id/transitions` - Получение возможных переходов статуса
- `POST /:id/files` - Загрузка файла в заявку
- `GET /:id/files` - Получение файлов заявки
- `DELETE /files/:fileId` - Удаление файла

### Админка (`/api/admin`)
- `GET /applications` - Получение всех заявок (менеджер+)
- `GET /applications/:id` - Получение деталей заявки (менеджер+)
- `PUT /applications/:id/status` - Обновление статуса заявки (менеджер+)
- `POST /applications/:id/reset-to-draft` - Возврат заявки в черновик (админ)
- `PUT /applications/:id/assign` - Назначение менеджера на заявку (админ)
- `POST /applications/:id/notes` - Добавление внутренней заметки (менеджер+)
- `GET /users` - Получение всех пользователей (админ)
- `PUT /users/:id/role` - Обновление роли пользователя (админ)
- `GET /stats/dashboard` - Получение статистики дашборда (менеджер+)

### Проверка состояния (`/api`)
- `GET /health` - Базовая проверка состояния
- `GET /health/detailed` - Подробная проверка состояния с подключением к БД
- `GET /test-db` - Проверка подключения к базе данных
- `GET /version` - Получение информации о версии API

## Модели данных

### Модель User
- **Поля**: id, email, password_hash, full_name, phone, company_name, is_email_verified, email_verification_token, reset_password_token, reset_password_expires, role, last_login_at
- **Роли**: client, manager, admin
- **Функции**: Мягкое удаление, подтверждение email, хеширование паролей

### Модель Application
- **Поля**: id, user_id, title, description, service_type, contact_full_name, contact_email, contact_phone, company_name, budget_range, status, internal_notes, priority, assigned_to, submitted_at
- **Статусы**: draft, submitted, in_review, needs_info, estimated, approved, in_progress, completed, cancelled
- **Типы услуг**: landing_page, corporate_site, ecommerce, web_application, redesign, other
- **Бюджетные диапазоны**: under_50k, 50k_100k, 100k_300k, 300k_500k, negotiable
- **Приоритеты**: low, normal, high, urgent

### Модель StatusHistory
- Отслеживает изменения статусов для заявок
- Поля: id, application_id, old_status, new_status, changed_by, comment

### Модель ApplicationFile
- Хранит файлы, связанные с заявками
- Поля: id, application_id, filename, original_name, path, size, mime_type, uploaded_by

## Особенности безопасности

1. **Аутентификация**: Аутентификация на основе JWT с токенами обновления
2. **Авторизация**: Контроль доступа на основе ролей (client, manager, admin)
3. **Ограничение частоты запросов**: Предотвращает злоупотребление с ограничениями на API запросы
4. **Валидация ввода**: Комплексная валидация всех входных данных
5. **Защита от SQL инъекций**: ORM Sequelize защищает от SQL инъекций
6. **Helmet**: Заголовки безопасности для Express приложения
7. **CORS**: Настроен для безопасного междоменного доступа
8. **Хеширование паролей**: bcrypt для безопасного хранения паролей

## Результаты тестирования

После последних исправлений система проходит 26 из 27 тестов, что составляет 96.3% успешных результатов. Основные функциональные возможности работают корректно:

- Проверки состояния
- Аутентификация (регистрация, вход, доступ к профилю)
- Управление заявками (создание, получение, обновление, отправка, удаление)
- Загрузка и управление файлами
- Функциональность административной панели
- Статистика пользователей

### Исправленные проблемы

1. **Удаление заявок**: Теперь клиенты могут удалять заявки в статусах DRAFT и SUBMITTED (ранее только DRAFT)
2. **Загрузка файлов**: Исправлены проблемы с доступом менеджеров к файлам заявок
3. **Обработка ошибок**: Улучшена обработка ошибок при загрузке файлов (размер, тип файла)
4. **Валидация**: Исправлены проблемы с валидацией в различных эндпоинтах

### Оставшиеся проблемы

1. **Изменение пароля**: Один тест продолжает завершаться с ошибкой 400, хотя функциональность работает при ручном тестировании

## Соглашения разработки

1. **Стиль кода**: Стандартный JavaScript с ESLint-форматированием
2. **Обработка ошибок**: Централизованное промежуточное ПО для обработки ошибок
3. **Логирование**: Логгер Winston с различными уровнями логов
4. **Переменные окружения**: dotenv для управления конфигурацией
5. **База данных**: PostgreSQL с ORM Sequelize
6. **Тестирование**: Структура поддерживает тестирование, хотя явные тесты не видны в текущей кодовой базе

## Тестовые данные

Приложение включает скрипт заполнения, который создает тестовых пользователей и заявки:
- Админ: admin@example.com / admin123
- Менеджер: manager@example.com / manager123
- Клиент: client@example.com / client123

Запустите `npm run seed`, чтобы заполнить базу данных тестовыми данными.

## Логирование

Приложение использует Winston для логирования с тремя различными выходами:
1. Логирование в консоль (с цветами)
2. Файл лога ошибок (`logs/error.log`)
3. Объединенный файл лога (`logs/combined.log`)

Уровни логов: error, warn, info, http, debug

## Примечания по деплою

Для деплоя в продакшн:
1. Установите `NODE_ENV` в `production`
2. Настройте SSL для подключений к базе данных
3. Настройте правильный обратный прокси (nginx/Apache)
4. Настройте менеджер процессов (PM2)
5. Настройте мониторинг и оповещения
6. Обеспечьте правильные права доступа к файлам для логов